<h1>Chat <%= @user_name %>@<%= @room_name %></h1>

<!-- チャット表示部分 -->

<ul id="chat_area">

</ul>

<!-- コメントフォーム -->

<%= label_tag "user_name", @user_name, id: "user_name" %>
<input id="comment" type="text">
<input id="send" type="button" value="send">

<script>

  var ws_dispatcher;
<% if Rails.env.production? %>
  ws_dispatcher = new WebSocketRails("peaceful-falls-25438.herokuapp.com/websocket");
<% else %>
  ws_dispatcher = new WebSocketRails("localhost:3000/websocket");
<% end %>

chanel_dispatcher = ws_dispatcher.subscribe('<%= @room_name %>');

  // メッセージ受信時の処理
  chanel_dispatcher.bind("websocket_chat", function(message){
    var message_li = document.createElement("li");
    message_li.textContent = message.user_name + ":" + message.msg_body;
    document.getElementById("chat_area").appendChild(message_li);
  })

  // メッセージ送信時の処理
  document.getElementById("send").onclick =  function(){
    var comment = document.getElementById("comment").value;
    var name = document.getElementById("user_name").innerText;
    chanel_dispatcher.trigger("websocket_chat", {user_name: name, msg_body: comment});
  }

</script>
